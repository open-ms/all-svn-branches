// -*- Mode: C++; tab-width: 2; -*-
// vi: set ts=2:
//
// --------------------------------------------------------------------------
//                   OpenMS Mass Spectrometry Framework 
// --------------------------------------------------------------------------
//  Copyright (C) 2003-2007 -- Oliver Kohlbacher, Knut Reinert
//
//  This library is free software; you can redistribute it and/or
//  modify it under the terms of the GNU Lesser General Public
//  License as published by the Free Software Foundation; either
//  version 2.1 of the License, or (at your option) any later version.
//
//  This library is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
//  Lesser General Public License for more details.
//
//  You should have received a copy of the GNU Lesser General Public
//  License along with this library; if not, write to the Free Software
//  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
//
// --------------------------------------------------------------------------
// $Maintainer: Cornelia Friedle $
// --------------------------------------------------------------------------

#include <OpenMS/VISUAL/DIALOGS/Spectrum3DCanvasPDP.h>
#include <OpenMS/VISUAL/Spectrum3DCanvas.h>
#include <OpenMS/VISUAL/ColorSelector.h>
#include <OpenMS/VISUAL/MultiGradientSelector.h>


// Qt
#include <QtGui/QLayout>
#include <QtGui/QRadioButton>
#include <QtGui/QLabel>
#include <q3groupbox.h>
#include <QtGui/QSpinBox>
#include <QtGui/QComboBox>
#include <QtGui/QGridLayout>
#include <Q3VButtonGroup>

using namespace std;

namespace OpenMS
{
	namespace Internal
	{
		Spectrum3DCanvasPDP::Spectrum3DCanvasPDP(Spectrum3DCanvas* manager, QWidget* parent,  Qt::WFlags f)
				: PreferencesDialogPage(manager,parent,f)
		{
			help_ = "This is the preferences dialog of 3D spectrum!"
								"<br>";
			QGridLayout* grid;
			QLabel * label;
			grid = new QGridLayout(this, 4, 2);
			grid->setMargin(6);
			grid->setSpacing(4);	

			Q3GroupBox* box = new Q3GroupBox(2,Qt::Horizontal,"Dot coloring",this);

			Q3VButtonGroup* coloring_group = new Q3VButtonGroup("Color Mode:",box);
			box->addSpace(0);  
			dot_mode_black_ = new QRadioButton("Black",coloring_group);
			dot_mode_gradient_ = new QRadioButton("Gradient",coloring_group);
			dot_gradient_ = new MultiGradientSelector(coloring_group);
		// 	box->addSpace(0);
			//		
			Q3HButtonGroup* interpolation_box = new Q3HButtonGroup("Interpolation steps",box);
			label = new QLabel("Interpolation steps: ",interpolation_box);
			dot_interpolation_steps_ = new QSpinBox(10,1000,1,interpolation_box,"");
			dot_interpolation_steps_->setSizePolicy(QSizePolicy::Fixed,QSizePolicy::Minimum);
			box->addSpace(0);
			Q3VButtonGroup* shading_group = new Q3VButtonGroup("Shade Mode:",box);
			//shading_group->setFrameStyle(QFrame::NoFrame);
			shade_mode_flat_ = new QRadioButton("Flat",shading_group);
			shade_mode_smooth_ = new QRadioButton("Smooth",shading_group);	
			grid->addMultiCellWidget(box,0,3,0,0);

			box = new Q3GroupBox(2,Qt::Horizontal,"Line Width",this);
			label = new QLabel("Line Width: ",box);
			dot_line_width_ = new QSpinBox(1,10,1,box,"");
			dot_line_width_->setSizePolicy(QSizePolicy::Fixed,QSizePolicy::Minimum);
			grid->addWidget(box,0,1);	

			box = new Q3GroupBox(2,Qt::Horizontal,"Colors",this);
			label = new QLabel("Background color: ",box);
			background_color_ = new ColorSelector(box);
			label = new QLabel("Axes Color: ",box);
			axes_color_ = new ColorSelector(box);
			grid->addWidget(box,1,1);	

			box = new Q3GroupBox(2,Qt::Horizontal,"Data",this);
			label = new QLabel("Reduction Mode:  ",box);
			data_reduction_ = new QComboBox(false, box, "read-only combobox");
			data_reduction_->insertItem("Reduction OFF");
			data_reduction_->insertItem("MaxReduction");
			data_reduction_->insertItem("SumReduction");
			label = new QLabel("Displayed Peaks : ",box);
			reduction_diplay_peaks_ = new QSpinBox(10000,50000,10000,box,"");
			
			grid->addWidget(box,2,1);
		
			load();
		}

		Spectrum3DCanvasPDP::~Spectrum3DCanvasPDP()
		{
			
		}
				
		void Spectrum3DCanvasPDP::load()
		{
			Spectrum3DCanvas* man = static_cast<Spectrum3DCanvas*>(manager_);
			
			if (man->getDotMode()==Spectrum3DCanvas::DOT_GRADIENT)
			{
				dot_mode_gradient_->setChecked(true);
			}
			else
			{
				if (man->getDotMode()==Spectrum3DCanvas::DOT_BLACK)
				{
					dot_mode_black_->setChecked(true);
				}
			}
			if (man->getShadeMode()==Spectrum3DCanvas::SHADE_FLAT)
			{
				shade_mode_flat_->setChecked(true);
			}
			else
			{
				if (man->getShadeMode()==Spectrum3DCanvas::SHADE_SMOOTH)
				{
					shade_mode_smooth_->setChecked(true);
				}
			}
			data_reduction_->setCurrentText(man->getPrefAsString("Preferences:3D:Reduction:Mode").c_str());	
			reduction_diplay_peaks_->setValue(UnsignedInt(man->getPrefAsInt("Preferences:3D:DisplayedPeaks")));
		
			background_color_->setColor(QColor(man->getPrefAsString("Preferences:3D:BackgroundColor").c_str()));
			dot_gradient_->gradient().fromString(man->getPref("Preferences:3D:Dot:Gradient"));
			dot_interpolation_steps_->setValue(UnsignedInt(man->getPref("Preferences:3D:Dot:InterpolationSteps")));
			dot_line_width_->setValue(UnsignedInt(man->getPref("Preferences:3D:Dot:LineWidth")));
			axes_color_->setColor(QColor(man->getPrefAsString("Preferences:3D:AxesColor").c_str()));
		}
		
		void Spectrum3DCanvasPDP::save()
		{
			Spectrum3DCanvas* man = static_cast<Spectrum3DCanvas*>(manager_);
			if(dot_mode_gradient_->isChecked())
			{
				man->setPref("Preferences:3D:Dot:Gradient",dot_gradient_->gradient().toString());
				man->setDotGradient(dot_gradient_->gradient().toString());
		
				man->setPref("Preferences:3D:Dot:InterpolationSteps",dot_interpolation_steps_->value());
		
				man->setPref("Preferences:3D:Dot:Mode",Spectrum3DCanvas::DOT_GRADIENT);
		
				if(shade_mode_flat_ -> isChecked())
				{
					man->setPref("Preferences:3D:Shade:Mode",Spectrum3DCanvas::SHADE_FLAT);
				}
				else if (shade_mode_smooth_->isChecked())
				{
					man->setPref("Preferences:3D:Shade:Mode",Spectrum3DCanvas::SHADE_SMOOTH);
				}
			}	
			else
			{ 
				if(dot_mode_black_->isChecked())
				{
					man->setPref("Preferences:3D:Dot:Mode",Spectrum3DCanvas::DOT_BLACK);
				}
			} 

			if(data_reduction_->currentText().toAscii().data()=="MaxReduction")
			{
				man->setPref("Preferences:3D:Data:Mode",Spectrum3DCanvas::REDUCTION_MAX);
			}
			else if(data_reduction_->currentText().toAscii().data()=="Reduction OFF")
			{
				man->setPref("Preferences:3D:Data:Mode",Spectrum3DCanvas::REDUCTION_OFF);
			}
			else if(data_reduction_->currentText().toAscii().data()=="SumReduction")
			{
				man->setPref("Preferences:3D:Data:Mode",Spectrum3DCanvas::REDUCTION_SUM);
			}
			
			man->setPref("Preferences:3D:Reduction:Mode", data_reduction_->currentText().toAscii().data());
			man->setPref("Preferences:3D:DisplayedPeaks",	reduction_diplay_peaks_->value());
			
			man->setPref("Preferences:3D:BackgroundColor",background_color_->getColor().name().toAscii().data());
			man->setPref("Preferences:3D:AxesColor",axes_color_->getColor().name().toAscii().data());
			man->setPref("Preferences:3D:Dot:LineWidth",dot_line_width_->value());
		
			man->setDataMode();
			man->repaintAll();	
		

		}
	} // namespace Internal
} //namespace

