# -*- Mode: makefile; tab-width: 2; -*-
# vi: set ts=2:
#
# ==========================================================================
#
# This is Makefile.in / Makefile
# Please do ONLY change Makefile.in,
# as Makefile is automagically
# created by configure from Makefile.in
#
# ==========================================================================
#
# --------------------------------------------------------------------------
#                   OpenMS Mass Spectrometry Framework
# --------------------------------------------------------------------------
#  Copyright (C) 2003-2008 -- Oliver Kohlbacher, Knut Reinert
#
#  This library is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public
#  License as published by the Free Software Foundation; either
#  version 2.1 of the License, or (at your option) any later version.
#
#  This library is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#  Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public
#  License along with this library; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# --------------------------------------------------------------------------
# $Maintainer: Marc Sturm $
# --------------------------------------------------------------------------

include config.mak

# 	library version number
LIB_VERSION	= @PACKAGE_VERSION@

# names of the static libraries
STATIC_LIBS	= libOpenMS.a

#	names of the shared libraries
SHARED_LIBS	= $(STATIC_LIBS:.a=.@SHARED_LIB_SUFFIX@)

# names of the library object file lists
OBJECT_LISTS = $(STATIC_LIBS:.a=.objects)

.SUFFIXES:	.objects .a	.@SHARED_LIB_SUFFIX@

.PHONY: dummy

default: help

help:
	@$(ECHO) "";
	@$(ECHO) "Main targets:";
	@$(ECHO) " [help]     shows this help";
	@$(ECHO) " lib        builds the OpenMS library";
	@$(ECHO) " install    installs the OpenMS library"; 
	@$(ECHO) " test       executes a test suite for the OpenMS library";
	@$(ECHO) " TOPP       builds the TOPP tools";
	@$(ECHO) " TOPPtest   executes a test suite for the TOPP tools";
	@$(ECHO) " UTILS      builds the UTILS tools";
	@$(ECHO) "";
	@$(ECHO) "Targets for developers:";
	@$(ECHO) " depend     updates source file dependencies";
	@$(ECHO) " recollect  updates the objects that are included in the library";
	@$(ECHO) " clean      removes object files";
	@$(ECHO) " distclean  removes all files not under SVN control";
	@$(ECHO) "";

sharedlibs: $(SHARED_LIBS)

staticlibs: $(STATIC_LIBS)

install:	install.shared
	@$(ECHO) " "
	@$(ECHO) "Don't forget to add the path"
	@$(ECHO) " "
	@$(ECHO) "   $(PREFIX)/lib/ "
	@$(ECHO) " "
	@$(ECHO) "to your @ADDITIONAL_COMMENTS@."
	@$(ECHO) " "
	@$(ECHO) "Please verify the validity of the installed library by executing"
	@$(ECHO) " "
	@$(ECHO) "   make test"
	@$(ECHO) " "
	@$(ECHO) "This will compile and run an extensive test suite."
	@$(ECHO) " "

clean:
	@$(ECHO) "Cleaning up object files, cores,  and (uninstalled) library files..."
	@cd CONCEPT; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd SYSTEM; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd MATH; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd DATASTRUCTURES; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd METADATA; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd KERNEL; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd FORMAT; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd FILTERING; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd COMPARISON; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd CHEMISTRY; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd TRANSFORMATIONS; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd ANALYSIS; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;   
	@cd APPLICATIONS; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ; 
	@cd VISUAL; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd TEST; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd EXAMPLES; if $(MAKE) default_clean; then cd .. ; else cd .. ; exit 1 ; fi ;
	@-$(RM) -f  $(STATIC_LIBS) $(SHARED_LIBS)
	@-$(RM) -rf core.* .Dependencies *.objects *~ @TEMPLATE_DIR@
	@cd $(OPENMS_PATH)/source/APPLICATIONS && make -f Makefile_SUBDIRS default_clean
	@cd $(OPENMS_PATH)/source/TEST/TOPP && make clean
	@${RM} -f $(OPENMS_PATH)/source/TEST/*.output

distclean: clean
	@-$(RM) -rf conf.diag.tar autom4te* config.lic config.log config.status config.mak config_defs.mak common.mak ../include/OpenMS/config.h Makefile  config.h ../bin ../lib
	@cd ../doc/; $(MAKE) clean

libclean:
	@$(ECHO) "Removing all installed libraries..."
	@-$(RM) -rf $(PREFIX)/lib/libOpenMS*.*


libOpenMS.objects:
	@$(ECHO)
	@$(ECHO) "Collecting object files for libraries..."
	@-rm -f libOpenMS.objects
	@cd CONCEPT; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd SYSTEM; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd MATH; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd DATASTRUCTURES; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd METADATA; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd KERNEL; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd FORMAT; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd FILTERING; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd COMPARISON; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd CHEMISTRY; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd TRANSFORMATIONS; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd ANALYSIS; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ;   
	@cd VISUAL; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ; 
	@cd APPLICATIONS; if $(MAKE) collectlib; then cd .. ; else cd .. ; exit 1 ; fi ; 


collect:	$(OBJECT_LISTS)

recollect:
	rm -f $(OBJECT_LISTS)
	@$(MAKE) collect


libOpenMS.@SHARED_LIB_SUFFIX@: collect
	@$(ECHO)
	@$(ECHO) "Linking shared library:  OpenMS"
ifeq (${OS},MINGW32)	
	$(DYNAR) $(DYNAROPTS) ${SHARED_LIBS} \
		-Wl,--entry,_DllMainCRTStartup@12 \
		-Wl,--image-base,0x5FBC0000 \
		-Wl,--export-all-symbols \
    -Wl,--enable-auto-import \
    -Wl,--whole-archive `cat libOpenMS.objects` \
    -Wl,--no-whole-archive ${LIBS_EXTERNAL} \
    -Wl,--large-address-aware

else
	$(DYNAR) $(DYNAROPTS) libOpenMS.@SHARED_LIB_SUFFIX@ `cat libOpenMS.objects` -lm
endif

.objects.a:	
	@$(ECHO)
	@$(ECHO) "Linking static library:  $@"
	$(AR) $(AROPTS) $*.a `cat $*.objects`

dirs: dummy
	@cd CONCEPT; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd SYSTEM; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd MATH; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd DATASTRUCTURES; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd METADATA; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd KERNEL; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd FORMAT; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd FILTERING; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd COMPARISON; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd CHEMISTRY; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd TRANSFORMATIONS; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd ANALYSIS; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;   
	@cd APPLICATIONS; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ; 
	@cd VISUAL; if $(MAKE) default; then cd .. ; else cd .. ; exit 1 ; fi ;

lib:	.Dependencies dirs
	@$(ECHO) " "
	@$(ECHO) "You may now install the libraries with the command"
	@$(ECHO) " "
	@$(ECHO) "   make install"
	@$(ECHO) " "


install.static:	$(STATIC_LIBS)
	@$(ECHO) Installing static libraries under $(PREFIX)/lib/...
	@-mkdir $(PREFIX) 2>/dev/null | cat >/dev/null
	@-mkdir $(PREFIX)/lib/ 2>/dev/null | cat >/dev/null
	@-mkdir $(PREFIX)/bin/ 2>/dev/null | cat >/dev/null
	@$(MV) -f $(STATIC_LIBS) $(PREFIX)/lib/
	@if test "$(PREFIX)" != "$(OPENMS_PATH)" ; then \
		mkdir $(PREFIX)/share/ 2>/dev/null | cat >/dev/null ; \
		mkdir $(PREFIX)/include/ 2>/dev/null | cat >/dev/null ; \
		$(CP) -rf $(OPENMS_PATH)/include/* $(PREFIX)/include/ ; \
		$(CP) -rf $(OPENMS_PATH)/share/* $(PREFIX)/share/ ; \
	fi


install.shared: $(SHARED_LIBS)
	@$(ECHO) Installing shared libraries under $(PREFIX)/lib/...
	@-mkdir $(PREFIX) 2>/dev/null | cat >/dev/null
	@-mkdir $(PREFIX)/lib/ 2>/dev/null | cat >/dev/null
	@-mkdir $(PREFIX)/bin/ 2>/dev/null | cat >/dev/null
	@$(MV) -f $(SHARED_LIBS) $(PREFIX)/lib/
	@if test "$(PREFIX)" != "$(OPENMS_PATH)" ; then \
		mkdir $(PREFIX)/share/ 2>/dev/null | cat >/dev/null ; \
		mkdir $(PREFIX)/include/ 2>/dev/null | cat >/dev/null ; \
		$(CP) -rf $(OPENMS_PATH)/include/* $(PREFIX)/include/ ; \
		$(CP) -rf $(OPENMS_PATH)/share/* $(PREFIX)/share/ ; \
	fi

.Dependencies:
	@$(MAKE) depend

%_dep : %
	@cd $<; if $(MAKE) depend; then cd .. ; else cd .. ; exit 1 ; fi ;

SOURCE_dep :
	@$(ECHO) "Creating dependencies..."
	@$(ECHO) "" >.Dependencies

APPLICATIONS_dep :
	@cd APPLICATIONS;	if $(MAKE) depend; then cd .. ; else cd .. ; exit 1 ; fi ;
	@cd APPLICATIONS; if $(MAKE) -f Makefile_SUBDIRS depend; then cd .. ; else cd .. ; exit 1 ; fi ;

depend: SOURCE_dep CONCEPT_dep TEST_dep SYSTEM_dep MATH_dep DATASTRUCTURES_dep METADATA_dep KERNEL_dep FORMAT_dep FILTERING_dep COMPARISON_dep CHEMISTRY_dep TRANSFORMATIONS_dep ANALYSIS_dep VISUAL_dep APPLICATIONS_dep EXAMPLES_dep APPLICATIONS_dep

depend_strip: depend
	@$(ECHO) "Stripping unneeded dependencies..."
	@ config/tools/dependencies-strip

# upon special request...
unwindowsify:  
	@$(ECHO) "Fixing file permissions and line endings..."
	@cd ..; find . -name \*.[hC] -o -name Makefile | xargs svn propdel svn:executable
	@cd ..; find . -name \*.[hC] -o -name Makefile | xargs dos2unix

test:	dummy
	@cd TEST ; $(MAKE) test

# build TOPP tools
TOPP:
	@cd APPLICATIONS/TOPP/ && make
	@cd $(OPENMS_PATH)/source/

# test TOPP tools
TOPPtest:
	@cd TEST/TOPP/ && make
	@cd $(OPENMS_PATH)/source/

# build UTILS tools
UTILS:
	@cd APPLICATIONS/UTILS/ && make
	@cd $(OPENMS_PATH)/source/

#
#    special targets - internal use only! 
#

dummy:



configure:  config/configure.in config/configure.header
	@$(ECHO) "Creating new ./configure from config/configure.in"
	@autoconf config/configure.in > configure.tmp
	@cat configure.tmp|sed "2r config/configure.header" >configure
	@-rm configure.tmp
	@chmod 755 configure

